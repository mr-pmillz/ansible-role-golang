# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Ansible role (`gantsign.golang`) that downloads and installs the Go language SDK on Linux with SHA256 checksum verification. Published to Ansible Galaxy. Supports 120+ Go versions across multiple distros and architectures.

## Commands

### Linting
```bash
tox run -e lint                    # Run all linters (yamllint, ansible-lint, flake8)
yamllint .                         # YAML lint only
ansible-lint .                     # Ansible lint only
flake8 --exclude .tox,.venv        # Python lint only
```

### Testing with Molecule
```bash
# Always run molecule through tox (direct `molecule test` fails with role-not-found)
tox run -e ansible-max -- --scenario-name=default
tox run -e ansible-max -- --scenario-name=rocky
tox run -e ansible-max -- --scenario-name=debian-max

# Available scenarios: default (Ubuntu 24.04), ubuntu-min, debian-max, debian-min,
#   rocky, fedora, opensuse, ubuntu-arm32v7, ubuntu-arm64v8, ubuntu-max-go-eol
```

### Dependency Management
```bash
# Requirements use pip-tools with hash verification
cd requirements && ./compile.sh    # Recompile all .txt from .in files
pip install -r requirements/dev.txt  # Install dev dependencies
```

### Adding New Go Versions
```bash
./add_new_versions.py              # Fetches new versions from go.dev API, generates checksum files
./go_versions_stable.sh            # Display current stable versions
```

## Architecture

### Task Flow (`tasks/main.yml`)
1. **Load architecture vars** — dynamic include from `vars/architecture/` based on `ansible_facts.architecture` + `userspace_bits`, falling back to `default.yml` (amd64)
2. **Load version vars** — dynamic include from `vars/versions/` matching `{version}-{arch}.yml` → `{version}.yml` → `default.yml`, provides SHA256 checksum
3. **Assert checksum exists** — fails if `golang_redis_sha256sum` is undefined
4. **Download** — fetches `go{version}.linux-{arch}.tar.gz` from mirror with checksum validation
5. **Install** — extracts to `/opt/go/{version}` with `--strip-components=1`
6. **Configure environment** — templates `/etc/profile.d/golang.sh` (sets GOROOT, PATH, optional GOPATH)
7. **Register facts** — creates `/etc/ansible/facts.d/golang.fact` exposing `ansible_local.golang.general.version` and `.home`

### Variable Loading Strategy
Architecture and version vars use a first-match pattern with `include_vars` + `first_found`:
- Architecture: `vars/architecture/{arch}-{bits}.yml` → `{arch}.yml` → `default.yml`
- Versions: `vars/versions/{version}-{golang_architecture}.yml` → `{version}.yml` → `default.yml`

This allows architecture-specific checksums (e.g., `1.24.1-arm64.yml`) while keeping a single file for versions that share a checksum across architectures.

### Key Directories
- `vars/versions/` — 500+ YAML files, each containing a single `golang_redis_sha256sum` value
- `vars/architecture/` — maps `ansible_facts.architecture` to Go's architecture naming (e.g., `aarch64` → `arm64`)
- `templates/golang.sh.j2` — shell profile script setting GOROOT/GOPATH/PATH
- `templates/facts.j2` — INI-format Ansible local facts file

### Default Variables (`defaults/main.yml`)
- `golang_version`: `'1.26.0'`
- `golang_mirror`: `'https://dl.google.com/go'`
- `golang_install_dir`: `/opt/go/{{ golang_version }}`
- `golang_gopath`: unset (optional)

## Conventions

- **Molecule prerequisite**: If molecule fails with `missing MANIFEST.json` for a collection, fix with `ansible-galaxy collection install <name> --force`
- **Version files** are generated by `add_new_versions.py` — don't hand-edit checksums
- **Minimum Ansible version**: 2.17 (enforced in `meta/main.yml`)
- **Python version**: 3.12 (see `.python-version`)
- **YAML style**: 2-space indent, 160-char line limit (see `.yamllint`, `.editorconfig`)
- **Molecule tests** use testinfra (`molecule/default/tests/test_role.py`) — tests source `/etc/profile` then verify env vars and command availability
- **CI matrix** tests across distros and two Ansible versions (min/max), with ARM scenarios on native ARM runners
